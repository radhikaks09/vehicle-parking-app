{% extends "dashboard.html" %}

{% block title %}View Parking Spots{% endblock %}

{% block main_dashboard %}
    <div class="card">
        <h2>Parking Spots in Lot: {{ lot.name }}</h2>
        <p>Location: {{ lot.location }} | Pincode: {{ lot.pincode }}</p>
    </div>

    <table>
        <thead>
            <tr>
                <th>Spot Number</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for spot in spots %}
                {% set active_res = spot.reservations | selectattr('is_active') | first %}
                <tr>
                    <td>{{ spot.spot_number }}</td>
                    <td>
                        {% if spot.is_occupied %}
                            {% if active_res and active_res.user_id == current_user_id %}
                                <span style="color: orange;">Reserved</span>
                            {% else %}
                                <span style="color: red;">Occupied</span>
                            {% endif %}
                        {% else %}
                            <span style="color: green;">Available</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if not spot.is_occupied %}
                            <a href="{{ url_for('user.reserve_spot', lot_id=lot.id, spot_number=spot.spot_number) }}">
                                <button>Reserve</button>
                            </a>
                        {% else %}
                            {% if active_res and active_res.user_id == current_user_id %}
                                <a href="{{ url_for('user.release_spot', lot_id=lot.id, spot_number=spot.spot_number) }}">
                                    <button>Release</button>
                                </a>
                            {% else %}
                                <span style="color: gray;">Cannot Book</span>
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <div style="margin-top: 20px;">
        <a href="{{ url_for('admin.dashboard') }}"><button>Back to Dashboard</button></a>
    </div>
{% endblock %}